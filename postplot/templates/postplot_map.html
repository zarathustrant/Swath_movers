<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Post Plot Acquisition Map - Swath Movers</title>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- Leaflet.PM CSS for drawing polygons -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.pm@latest/dist/leaflet.pm.css" />

    <style>
        @import url("https://fonts.cdnfonts.com/css/thegoodmonolith");

        @font-face {
            font-family: "PPNeueMontreal";
            src: url("https://assets.codepen.io/7558/PPNeueMontreal-Variable.woff2") format("woff2");
            font-weight: 100 900;
            font-style: normal;
        }

        :root {
            --color-bg: #0a0a0a;
            --color-text: #ffffff;
            --color-text-dim: rgba(255, 255, 255, 0.6);
            --color-accent: #A64B23;
            --color-accent-dark: #2C1B14;
            --transition-smooth: 0.3s cubic-bezier(0.87, 0, 0.13, 1);
            --font-base: "PPNeueMontreal", sans-serif;
            --font-mono: "TheGoodMonolith", monospace;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            user-select: none;
        }

        body {
            font-family: var(--font-base);
            background: var(--color-bg);
            overflow: hidden;
            color: var(--color-text);
            -webkit-font-smoothing: antialiased;
        }

        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            left: 0;
            right: 0;
        }

        /* Page vignette effect */
        .page-vignette {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 9998;
            background: radial-gradient(
                circle at center,
                transparent 20%,
                rgba(0, 0, 0, 0.4) 70%,
                rgba(0, 0, 0, 0.7) 100%
            );
        }

        /* Control panels - dark theme */
        .leaflet-control {
            background: rgba(26, 26, 26, 0.95) !important;
            backdrop-filter: blur(10px);
            border-radius: 8px !important;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5) !important;
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
        }

        .leaflet-control a,
        .leaflet-control button {
            background: rgba(255, 255, 255, 0.05) !important;
            color: var(--color-text) !important;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1) !important;
        }

        .leaflet-control a:hover,
        .leaflet-control button:hover {
            background: rgba(255, 255, 255, 0.1) !important;
        }

        .leaflet-bar {
            border: none !important;
        }

        /* ===== TABBED SIDE PANEL ===== */

        .side-panel {
            position: fixed;
            left: 0;
            top: 0;
            height: 100%;
            width: 350px;
            background: rgba(15, 15, 15, 0.95);
            backdrop-filter: blur(20px);
            box-shadow: 4px 0 40px rgba(0, 0, 0, 0.8);
            border-right: 1px solid rgba(255, 255, 255, 0.05);
            z-index: 1500;
            display: flex;
            font-family: var(--font-base);
            transition: transform var(--transition-smooth);
        }

        .side-panel.collapsed {
            transform: translateX(-310px);
        }

        /* Tab buttons on the side */
        .panel-tabs {
            width: 40px;
            background: rgba(0, 0, 0, 0.8);
            border-right: 1px solid rgba(255, 255, 255, 0.05);
            display: flex;
            flex-direction: column;
            padding-top: 60px;
            gap: 2px;
        }

        .panel-tab-btn {
            width: 40px;
            height: 50px;
            background: transparent;
            border: none;
            border-left: 3px solid transparent;
            color: var(--color-text-dim);
            font-size: 18px;
            cursor: pointer;
            transition: all var(--transition-smooth);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .panel-tab-btn:hover {
            background: rgba(255, 255, 255, 0.05);
            color: var(--color-text);
        }

        .panel-tab-btn.active {
            background: rgba(166, 75, 35, 0.1);
            border-left-color: var(--color-accent);
            color: var(--color-text);
        }

        /* Toggle button */
        .panel-toggle {
            position: absolute;
            right: -30px;
            top: 10px;
            width: 30px;
            height: 50px;
            background: rgba(15, 15, 15, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-left: none;
            border-radius: 0 8px 8px 0;
            color: var(--color-text);
            font-size: 18px;
            cursor: pointer;
            box-shadow: 2px 0 15px rgba(0, 0, 0, 0.5);
            transition: all var(--transition-smooth);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .panel-toggle:hover {
            background: rgba(25, 25, 25, 0.98);
            transform: translateX(2px);
        }

        /* Panel content area */
        .panel-content-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .panel-header {
            background: rgba(0, 0, 0, 0.5);
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            color: var(--color-text);
            padding: 20px;
        }

        .panel-header h3 {
            margin: 0 0 5px 0;
            font-size: 18px;
            font-weight: 500;
            letter-spacing: -0.02em;
        }

        .panel-header .username {
            font-size: 11px;
            font-family: var(--font-mono);
            opacity: 0.5;
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        .panel-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: none;
        }

        .panel-content.active {
            display: block;
        }

        /* Actions Tab Content */
        .action-link {
            display: block;
            padding: 12px 15px;
            margin: 8px 0;
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(10px);
            border-left: 3px solid rgba(166, 75, 35, 0.3);
            border-radius: 6px;
            color: var(--color-text);
            text-decoration: none;
            font-size: 14px;
            transition: all var(--transition-smooth);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .action-link:hover {
            background: rgba(255, 255, 255, 0.08);
            border-left-color: var(--color-accent);
            transform: translateX(4px);
            border-color: rgba(255, 255, 255, 0.1);
        }

        .action-link .icon {
            margin-right: 8px;
            opacity: 0.7;
        }

        .action-separator {
            margin: 20px 0;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Filter Tab Content */
        .filter-section h4 {
            margin: 0 0 15px 0;
            font-size: 13px;
            color: var(--color-text);
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            opacity: 0.7;
        }

        .filter-checkbox {
            display: block;
            margin: 10px 0;
            font-size: 13px;
            cursor: pointer;
            user-select: none;
            color: var(--color-text-dim);
            transition: color var(--transition-smooth);
        }

        .filter-checkbox:hover {
            color: var(--color-text);
        }

        .filter-checkbox input[type="checkbox"],
        .filter-checkbox input[type="radio"] {
            margin-right: 8px;
            cursor: pointer;
            accent-color: var(--color-accent);
        }

        .filter-actions {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .filter-btn {
            width: 100%;
            padding: 10px;
            margin: 5px 0;
            background: rgba(166, 75, 35, 0.2);
            color: var(--color-text);
            border: 1px solid rgba(166, 75, 35, 0.4);
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            font-family: var(--font-base);
            transition: all var(--transition-smooth);
            backdrop-filter: blur(10px);
        }

        .filter-btn:hover {
            background: rgba(166, 75, 35, 0.3);
            border-color: var(--color-accent);
            transform: translateY(-1px);
        }

        .filter-btn.secondary {
            background: rgba(255, 255, 255, 0.05);
            border-color: rgba(255, 255, 255, 0.1);
            font-size: 12px;
            padding: 8px;
        }

        .filter-btn.secondary:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: rgba(255, 255, 255, 0.2);
        }

        /* Selection Tab Content */
        .selection-results {
            /* Will be populated dynamically */
        }

        .selection-empty {
            text-align: center;
            padding: 40px 20px;
            color: var(--color-text-dim);
        }

        .selection-empty-icon {
            font-size: 48px;
            margin-bottom: 15px;
            opacity: 0.3;
        }

        .selection-empty-text {
            font-size: 14px;
            margin-bottom: 8px;
            color: var(--color-text);
        }

        .selection-empty-hint {
            font-size: 12px;
            opacity: 0.5;
        }

        .selection-summary {
            background: rgba(166, 75, 35, 0.1);
            border: 1px solid rgba(166, 75, 35, 0.3);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
        }

        .summary-stat {
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
            font-size: 13px;
        }

        .summary-stat strong {
            color: var(--color-text-dim);
            font-weight: 500;
        }

        .summary-stat span {
            color: var(--color-accent);
            font-weight: 600;
            font-family: var(--font-mono);
        }

        .selection-list {
            /* Items styling */
        }

        .selection-item {
            background: rgba(255, 255, 255, 0.03);
            border-left: 3px solid rgba(166, 75, 35, 0.5);
            border-radius: 6px;
            padding: 12px 15px;
            margin-bottom: 12px;
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-left-width: 3px;
            transition: all var(--transition-smooth);
            backdrop-filter: blur(10px);
        }

        .selection-item:hover {
            background: rgba(255, 255, 255, 0.06);
            border-color: rgba(255, 255, 255, 0.1);
            transform: translateX(4px);
        }

        .selection-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .selection-line-number {
            font-size: 15px;
            font-weight: 500;
            color: var(--color-text);
        }

        .selection-swath-badge {
            background: rgba(166, 75, 35, 0.2);
            color: var(--color-text);
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
            letter-spacing: 0.5px;
            border: 1px solid rgba(166, 75, 35, 0.4);
            font-family: var(--font-mono);
            text-transform: uppercase;
        }

        .selection-ranges {
            font-family: var(--font-mono);
            font-size: 12px;
            color: var(--color-text-dim);
            line-height: 1.6;
        }

        /* Swath-specific colors */
        .selection-item[data-swath="1"] { border-left-color: #e74c3c; }
        .selection-item[data-swath="2"] { border-left-color: #3498db; }
        .selection-item[data-swath="3"] { border-left-color: #2ecc71; }
        .selection-item[data-swath="4"] { border-left-color: #f39c12; }
        .selection-item[data-swath="5"] { border-left-color: #9b59b6; }
        .selection-item[data-swath="6"] { border-left-color: #1abc9c; }
        .selection-item[data-swath="7"] { border-left-color: #e67e22; }
        .selection-item[data-swath="8"] { border-left-color: #34495e; }

        /* Scrollbar styling */
        .panel-content::-webkit-scrollbar {
            width: 6px;
        }

        .panel-content::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.3);
        }

        .panel-content::-webkit-scrollbar-thumb {
            background: rgba(166, 75, 35, 0.3);
            border-radius: 3px;
        }

        .panel-content::-webkit-scrollbar-thumb:hover {
            background: rgba(166, 75, 35, 0.5);
        }

        /* Upload Tab Styling */
        .upload-subsection {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            padding: 0;
            margin-bottom: 15px;
            overflow: hidden;
        }

        .upload-subsection-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            padding: 12px 15px;
            background: rgba(0, 0, 0, 0.2);
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            transition: all var(--transition-smooth);
        }

        .upload-subsection-header:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .upload-subsection-header h4 {
            font-size: 13px;
            font-weight: 500;
            margin: 0;
            color: var(--color-text);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .toggle-icon {
            font-size: 12px;
            color: var(--color-text-dim);
            transition: transform var(--transition-smooth);
        }

        .upload-subsection.collapsed .toggle-icon {
            transform: rotate(-90deg);
        }

        .upload-subsection-body {
            padding: 15px;
        }

        .upload-subsection.collapsed .upload-subsection-body {
            display: none;
        }

        .form-group {
            margin: 12px 0;
        }

        .form-label {
            display: block;
            font-size: 11px;
            color: var(--color-text-dim);
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 500;
        }

        .form-select, .form-file-input {
            width: 100%;
            padding: 10px 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            color: var(--color-text);
            font-size: 13px;
            font-family: var(--font-base);
            transition: all var(--transition-smooth);
        }

        .form-select:focus, .form-file-input:focus {
            outline: none;
            border-color: var(--color-accent);
            background: rgba(255, 255, 255, 0.08);
        }

        .form-select option {
            background: #1a1a1a;
            color: var(--color-text);
        }

        .upload-btn {
            width: 100%;
            padding: 10px;
            background: linear-gradient(135deg, var(--color-accent) 0%, #8b4513 100%);
            border: none;
            border-radius: 4px;
            color: var(--color-text);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-smooth);
            margin-top: 10px;
            font-family: var(--font-base);
        }

        .upload-btn:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(166, 75, 35, 0.3);
        }

        .upload-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .upload-status {
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
            font-size: 12px;
            line-height: 1.5;
            display: none;
            white-space: pre-line;
        }

        .upload-status.success {
            background: rgba(6, 228, 24, 0.1);
            border: 1px solid rgba(6, 228, 24, 0.3);
            color: #06e418;
        }

        .upload-status.error {
            background: rgba(245, 3, 3, 0.1);
            border: 1px solid rgba(245, 3, 3, 0.3);
            color: #f50303;
        }

        .upload-status.info {
            background: rgba(5, 122, 240, 0.1);
            border: 1px solid rgba(5, 122, 240, 0.3);
            color: #057af0;
        }

        .mini-progress-bar {
            width: 100%;
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            overflow: hidden;
            margin-top: 8px;
        }

        .mini-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--color-accent) 0%, #d4a574 100%);
            transition: width 0.3s ease;
            width: 0%;
        }

        .file-list {
            margin-top: 8px;
            font-size: 11px;
            color: var(--color-text-dim);
            font-family: var(--font-mono);
        }

        .quick-stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 10px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 4px;
            padding: 12px;
            text-align: center;
        }

        .stat-card-value {
            font-size: 18px;
            font-weight: 600;
            color: var(--color-accent);
            font-family: var(--font-mono);
        }

        .stat-card-label {
            font-size: 10px;
            color: var(--color-text-dim);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 4px;
        }

        .stat-card-detail {
            font-size: 9px;
            color: var(--color-text-dim);
            margin-top: 3px;
        }

        #legend {
            position: absolute;
            bottom: 30px;
            right: 10px;
            z-index: 1000;
            background: rgba(15, 15, 15, 0.95);
            backdrop-filter: blur(20px);
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.1);
            max-width: 220px;
        }

        #legend h4 {
            margin: 0 0 12px 0;
            font-size: 13px;
            color: var(--color-text);
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            opacity: 0.7;
        }

        #legend .legend-item {
            margin: 10px 0;
            display: flex;
            align-items: center;
            font-size: 12px;
            color: var(--color-text-dim);
        }

        #legend .legend-line {
            display: inline-block;
            width: 30px;
            height: 3px;
            margin-right: 10px;
        }

        #legend .legend-point {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 10px;
        }

        #stats-panel {
            position: absolute;
            bottom: 30px;
            left: 370px;
            z-index: 1000;
            background: rgba(15, 15, 15, 0.95);
            backdrop-filter: blur(20px);
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.1);
            min-width: 240px;
            transition: left var(--transition-smooth);
        }

        .side-panel.collapsed ~ #stats-panel {
            left: 50px;
        }

        #stats-panel h4 {
            margin: 0 0 12px 0;
            font-size: 13px;
            color: var(--color-text);
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            opacity: 0.7;
        }

        #stats-panel .stat-row {
            margin: 6px 0;
            font-size: 13px;
            color: var(--color-text-dim);
        }

        #stats-panel .stat-label {
            font-weight: 500;
            color: var(--color-text-dim);
        }

        #stats-panel .divider {
            margin: 12px 0;
            padding-top: 12px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }


        /* Loading indicator */
        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 2000;
            background: rgba(15, 15, 15, 0.95);
            backdrop-filter: blur(20px);
            padding: 20px 40px;
            border-radius: 8px;
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.9);
            border: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 14px;
            color: var(--color-text);
            font-family: var(--font-base);
            display: none;
        }

        #loading.active {
            display: block;
        }

        /* Line labels */
        .line-label {
            background: none;
            border: none;
            box-shadow: none;
            font-weight: bold;
            font-size: 11px;
            color: #057af0;
            text-shadow: 1px 1px 2px white, -1px -1px 2px white;
        }

    </style>
</head>
<body>
    <!-- Page vignette overlay -->
    <div class="page-vignette"></div>

    <!-- Tabbed Side Panel -->
    <div class="side-panel" id="side-panel">
        <button class="panel-toggle" id="panel-toggle">&#9776;</button>

        <div class="panel-tabs">
            <button class="panel-tab-btn active" data-tab="actions" title="Actions">&#8962;</button>
            <button class="panel-tab-btn" data-tab="filter" title="Filter">&#9776;</button>
            <button class="panel-tab-btn" data-tab="selection" title="Selection">&#127919;</button>
            <button class="panel-tab-btn" data-tab="upload" title="Upload">&#128228;</button>
        </div>

        <div class="panel-content-area">
            <div class="panel-header">
                <h3 id="panel-title">Actions</h3>
                <div class="username">{{ username }}</div>
            </div>

            <!-- Tab 1: Actions -->
            <div class="panel-content active" id="actions-content">
                <a href="#" class="action-link" onclick="switchToUploadTab(); return false;">
                    <span class="icon">&#128228;</span> Upload Post Plot Data
                </a>
                <a href="/map" class="action-link">
                    <span class="icon">&#128506;</span> Deployment Map
                </a>

                <div class="action-separator"></div>

                <div class="filter-section" style="margin-top: 10px;">
                    <h4>Base Map</h4>
                    <label class="filter-checkbox">
                        <input type="radio" name="basemap" value="satellite" checked> Google Earth (Satellite)
                    </label>
                    <label class="filter-checkbox">
                        <input type="radio" name="basemap" value="carto"> White Carto
                    </label>
                    <label class="filter-checkbox">
                        <input type="radio" name="basemap" value="topo"> OpenTopo
                    </label>
                </div>

                <div class="action-separator"></div>
                <a href="/logout" class="action-link">
                    <span class="icon">&#128682;</span> Logout
                </a>
            </div>

            <!-- Tab 2: Filter -->
            <div class="panel-content" id="filter-content">
                <div class="filter-section">
                    <h4>Select Swaths</h4>
                    <label class="filter-checkbox">
                        <input type="checkbox" value="1" checked> Swath 1
                    </label>
                    <label class="filter-checkbox">
                        <input type="checkbox" value="2" checked> Swath 2
                    </label>
                    <label class="filter-checkbox">
                        <input type="checkbox" value="3" checked> Swath 3
                    </label>
                    <label class="filter-checkbox">
                        <input type="checkbox" value="4" checked> Swath 4
                    </label>
                    <label class="filter-checkbox">
                        <input type="checkbox" value="5" checked> Swath 5
                    </label>
                    <label class="filter-checkbox">
                        <input type="checkbox" value="6" checked> Swath 6
                    </label>
                    <label class="filter-checkbox">
                        <input type="checkbox" value="7" checked> Swath 7
                    </label>
                    <label class="filter-checkbox">
                        <input type="checkbox" value="8" checked> Swath 8
                    </label>
                </div>
                <div class="filter-actions">
                    <button class="filter-btn" id="apply-swath-filter">Apply Filter</button>
                    <button class="filter-btn secondary" id="toggle-all-swaths">Deselect All</button>
                </div>
            </div>

            <!-- Tab 3: Selection Results -->
            <div class="panel-content" id="selection-content">
                <div class="selection-empty">
                    <div class="selection-empty-icon">&#127919;</div>
                    <div class="selection-empty-text">No Selection Yet</div>
                    <div class="selection-empty-hint">Draw a polygon on the map to select unacquired shots</div>
                </div>
            </div>

            <!-- Tab 4: Upload Data -->
            <div class="panel-content" id="upload-content">
                <!-- S01 Source File Upload Section -->
                <div class="upload-subsection" id="s01-section">
                    <div class="upload-subsection-header" onclick="toggleSection('s01-section')">
                        <h4>Source File (.s01)</h4>
                        <span class="toggle-icon">▼</span>
                    </div>
                    <div class="upload-subsection-body">
                        <div class="form-group">
                            <label class="form-label">Transformation Method</label>
                            <select id="panel-transformation-select" class="form-select">
                                <option value="">Loading...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Select .s01 File</label>
                            <input type="file" id="panel-s01-file" accept=".s01" class="form-file-input">
                        </div>
                        <button class="upload-btn" id="panel-s01-upload-btn" onclick="uploadS01FromPanel()">
                            <span id="s01-btn-text">Upload Source File</span>
                            <span id="s01-loading" style="display:none;">⏳ Uploading...</span>
                        </button>
                        <div id="panel-s01-status" class="upload-status"></div>
                    </div>
                </div>

                <!-- Acquisition Data Upload Section -->
                <div class="upload-subsection" id="acquisition-section">
                    <div class="upload-subsection-header" onclick="toggleSection('acquisition-section')">
                        <h4>Acquisition Data</h4>
                        <span class="toggle-icon">▼</span>
                    </div>
                    <div class="upload-subsection-body">
                        <div class="form-group">
                            <label class="form-label">Target Swath</label>
                            <select id="panel-acquisition-swath" class="form-select">
                                <option value="">Select Swath</option>
                                <option value="1">Swath 1</option>
                                <option value="2">Swath 2</option>
                                <option value="3">Swath 3</option>
                                <option value="4">Swath 4</option>
                                <option value="5">Swath 5</option>
                                <option value="6">Swath 6</option>
                                <option value="7">Swath 7</option>
                                <option value="8">Swath 8</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Files (.xlsx, .csv)</label>
                            <input type="file" id="panel-acquisition-file" accept=".csv,.xlsx" multiple class="form-file-input">
                            <div id="panel-file-list" class="file-list"></div>
                        </div>
                        <button class="upload-btn" id="panel-acquisition-upload-btn" onclick="uploadAcquisitionFromPanel()">
                            <span id="acq-btn-text">Upload Acquisition Data</span>
                            <span id="acq-loading" style="display:none;">⏳ Processing...</span>
                        </button>
                        <div class="mini-progress-bar" id="acq-progress-bar" style="display:none;">
                            <div class="mini-progress-fill" id="acq-progress-fill"></div>
                        </div>
                        <div id="panel-acquisition-status" class="upload-status"></div>
                    </div>
                </div>

                <!-- Quick Stats Overview Section -->
                <div class="upload-subsection">
                    <div class="upload-subsection-header">
                        <h4>Data Overview</h4>
                        <button class="filter-btn secondary" onclick="refreshStats()" style="width:auto; padding:5px 10px; font-size:11px; margin:0;">
                            Refresh
                        </button>
                    </div>
                    <div class="upload-subsection-body">
                        <div class="quick-stats-grid" id="quick-stats-grid">
                            <!-- Dynamically populated -->
                        </div>
                        <button class="filter-btn secondary" onclick="window.open('/postplot/upload', '_blank')" style="margin-top:10px;">
                            View Full Details
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Map container -->
    <div id="map"></div>

    <!-- Loading indicator -->
    <div id="loading">
        Loading map data...
    </div>

    <!-- Statistics panel -->
    <div id="stats-panel">
        <h4>Acquisition Stats</h4>
        <div class="stat-row">
            <span class="stat-label">Total Sources:</span> <span id="total-sources">0</span>
        </div>
        <div class="stat-row" style="color: #06e418;">
            <span class="stat-label">Acquired:</span> <span id="acquired-sources">0</span>
            (<span id="acquired-pct">0%</span>)
        </div>
        <div class="stat-row" style="color: #f50303;">
            <span class="stat-label">Pending:</span> <span id="pending-sources">0</span>
        </div>
        <div class="divider">
            <div class="stat-row" style="font-size: 12px;">
                <span class="stat-label">Receiver Lines:</span> <span id="receiver-count">0</span>
            </div>
        </div>
    </div>

    <!-- Legend -->
    <div id="legend">
        <h4>Legend</h4>
        <div class="legend-item">
            <span class="legend-line" style="background: #057af0;"></span>
            <span>Receiver Lines</span>
        </div>
        <div class="legend-item">
            <span class="legend-point" style="background: #f50303;"></span>
            <span>Source (Not Acquired)</span>
        </div>
        <div class="legend-item">
            <span class="legend-point" style="background: #06e418;"></span>
            <span>Source (Acquired)</span>
        </div>
    </div>


    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- Leaflet.PM JS for drawing polygons -->
    <script src="https://unpkg.com/leaflet.pm@latest/dist/leaflet.pm.min.js"></script>

    <script>
        // Initialize map
        const map = L.map('map', {
            center: [5.5, 7.0],
            zoom: 13,
            preferCanvas: true,
            renderer: L.canvas(),
            zoomControl: false  // We'll add it on the right
        });

        // Add zoom control on the right side
        L.control.zoom({
            position: 'topright'
        }).addTo(map);

        // Define base layers
        const googleSatellite = L.tileLayer('https://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
            maxZoom: 20,
            subdomains: ['mt0', 'mt1', 'mt2', 'mt3'],
            attribution: '© Google'
        });

        const cartoLight = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
            attribution: '© OpenStreetMap contributors © CARTO',
            maxZoom: 19
        });

        const openTopo = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
            attribution: 'Map data © OpenStreetMap contributors',
            maxZoom: 19
        });

        // Add default base layer (Google Satellite)
        let currentBaseLayer = googleSatellite;
        currentBaseLayer.addTo(map);

        // Store base layers for switching
        const baseLayers = {
            'satellite': googleSatellite,
            'carto': cartoLight,
            'topo': openTopo
        };

        // Layers
        let receiverLinesLayer = L.geoJSON(null, {
            style: function(feature) {
                return {
                    color: '#057af0',
                    weight: 2,
                    opacity: 0.8
                };
            },
            onEachFeature: function(feature, layer) {
                // Add tooltip with line info
                if (feature.properties.line) {
                    layer.bindTooltip(
                        `Line ${feature.properties.line}`,
                        { permanent: false, direction: 'center', className: 'line-label' }
                    );
                }

                // Add line number label (only once per line number)
                if (feature.properties.display_label) {
                    const coords = feature.geometry.coordinates;
                    const midpoint = coords[Math.floor(coords.length / 2)];

                    L.marker([midpoint[1], midpoint[0]], {
                        icon: L.divIcon({
                            className: 'line-label',
                            html: `<div>${feature.properties.display_label}</div>`,
                            iconSize: [40, 20]
                        })
                    }).addTo(map);
                }
            }
        }).addTo(map);

        let sourcePointsLayer = L.geoJSON(null, {
            pointToLayer: function(feature, latlng) {
                const color = feature.properties.is_acquired ? '#06e418' : '#f50303';

                return L.circleMarker(latlng, {
                    radius: 2,
                    fillColor: color,
                    color: color,
                    weight: 0.5,
                    opacity: 0.8,
                    fillOpacity: 0.7
                });
            },
            onEachFeature: function(feature, layer) {
                const props = feature.properties;
                const status = props.is_acquired ? 'ACQUIRED ✓' : 'NOT ACQUIRED';
                const statusColor = props.is_acquired ? 'green' : 'red';

                let popupContent = `
                    <b>Line:</b> ${props.line}<br>
                    <b>Shotpoint:</b> ${props.shotpoint}<br>
                    <b>Swath:</b> ${props.swath}<br>
                    <b>Status:</b> <span style="color: ${statusColor}; font-weight: bold;">${status}</span>
                `;

                if (props.acquired_at) {
                    popupContent += `<br><b>Acquired:</b> ${new Date(props.acquired_at).toLocaleString()}`;
                }

                layer.bindPopup(popupContent);
            }
        }).addTo(map);

        // Track dynamically created line layers and label markers for removal
        let currentLineLayers = [];
        let currentLabelMarkers = [];

        // Load map data
        function loadMapData(selectedSwaths = [1,2,3,4,5,6,7,8]) {
            const loading = document.getElementById('loading');
            loading.classList.add('active');

            console.log('Loading map data for swaths:', selectedSwaths);

            // Clear existing layers
            receiverLinesLayer.clearLayers();
            sourcePointsLayer.clearLayers();

            // Remove all dynamically created line layers from previous load
            currentLineLayers.forEach(layer => {
                map.removeLayer(layer);
            });
            currentLineLayers = [];

            // Remove all label markers from previous load
            currentLabelMarkers.forEach(marker => {
                map.removeLayer(marker);
            });
            currentLabelMarkers = [];

            // Load receiver lines (filtered by swath) - EXACT APPROACH FROM map.html
            fetch('/geojson_lines')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Received geojson_lines data:', data);

                    if (!data.swaths) {
                        console.error('No swaths property in data');
                        return;
                    }

                    console.log('Swath keys:', Object.keys(data.swaths));
                    console.log('Number of swaths:', Object.keys(data.swaths).length);

                    let totalReceiverLines = 0;

                    // Process each swath - EXACT SAME AS map.html
                    Object.entries(data.swaths).forEach(([swathName, geojson]) => {
                        // Extract swath number from name (swathName is just "1", "2", etc., not "swath_1")
                        const swathNum = parseInt(swathName);

                        console.log(`Found swath key: ${swathName}, parsed number: ${swathNum}`);

                        // Skip if this swath is not selected
                        if (!selectedSwaths.includes(swathNum)) {
                            console.log(`Skipping swath ${swathNum} (not in selected list)`);
                            return;
                        }

                        console.log(`Processing swath ${swathName}, features:`, geojson.features.length);

                        // Add ENTIRE geojson to map - NO FILTERING (same as map.html)
                        const lineLayer = L.geoJSON(geojson, {
                            style: feature => {
                                if (feature.geometry.type === "LineString" && feature.properties.type === "swath_edge") {
                                    return {
                                        color: "#e74c3c",
                                        weight: 2,
                                        dashArray: "5,5"
                                    };
                                }
                                return {
                                    color: "#057af0",
                                    weight: 2,
                                    opacity: 0.8
                                };
                            },
                            onEachFeature: (feature, layer) => {
                                const props = feature.properties;
                                if (feature.geometry.type === "LineString") {
                                    const { line, first_shot, last_shot, type, extended_points } = props;
                                    layer.bindTooltip(`Line ${line}<br>Shots ${first_shot}–${last_shot}`, { sticky: true });
                                    totalReceiverLines++;

                                    let color = 'black';
                                    if (type === 'R') color = 'blue';
                                    if (type === 'S') color = 'red';

                                    // Only show label if display_label is not empty
                                    const displayLabel = feature.properties.display_label;
                                    if (displayLabel && extended_points && extended_points.length >= 10) {
                                        const [lon3, lat3] = extended_points[2];   // 3rd point
                                        const [lon10, lat10] = extended_points[9]; // 10th point

                                        // Correct longitude distortion by latitude
                                        const latCorrection = Math.cos(lat3 * Math.PI / 180);
                                        const dx = (lon10 - lon3) * latCorrection;
                                        const dy = lat10 - lat3;
                                        let angle = Math.atan2(dy, dx) * (260 / Math.PI);

                                        // Add vertical offset to the label position (move upward visually)
                                        const verticalOffset = 0.002; // Small value ~10 meters up
                                        const horizontalOffset = 0.0008;
                                        const labelLat = lat3 + verticalOffset;
                                        const labelLon = lon3 + horizontalOffset;

                                        const labelMarker = L.marker([labelLat, labelLon], {
                                            icon: L.divIcon({
                                                className: 'custom-line-label',
                                                html: `<div style="
                                                    color: ${color};
                                                    font-weight: bold;
                                                    font-size: 11px;
                                                    transform: rotate(${angle}deg);
                                                    transform-origin: left center;
                                                    text-shadow: 1px 1px 2px white;
                                                    white-space: nowrap;
                                                ">${displayLabel}</div>`,
                                                iconSize: [60, 12],
                                                iconAnchor: [0, 6]
                                            }),
                                            interactive: false
                                        }).addTo(map);

                                        // Track this label marker for removal later
                                        currentLabelMarkers.push(labelMarker);
                                    }
                                }

                                // Handle swath edge lines
                                if (feature.geometry.type === "LineString" && feature.properties.type === "swath_edge") {
                                    const edgeName = feature.properties.name || `Swath ${swathName}`;
                                    layer.bindTooltip(edgeName, { sticky: true });
                                }
                            }
                        }).addTo(map);

                        // Track this layer for removal later
                        currentLineLayers.push(lineLayer);

                        console.log(`Added all features from ${swathName} to map`);
                    });

                    console.log(`Total receiver lines added: ${totalReceiverLines}`);
                    document.getElementById('receiver-count').textContent = totalReceiverLines.toLocaleString();
                })
                .catch(error => {
                    console.error('Error loading receiver lines:', error);
                    alert('Failed to load receiver lines: ' + error.message);
                });

            // Load source points (filtered by swath)
            // Add timestamp to prevent caching issues after acquisition uploads
            const swathParam = selectedSwaths.join(',');
            const timestamp = new Date().getTime();
            fetch(`/postplot/geojson/source_points?swaths=${swathParam}&_t=${timestamp}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Received source points data:', data);
                    sourcePointsLayer.addData(data);
                    updateStatistics(data);
                    loading.classList.remove('active');
                })
                .catch(error => {
                    console.error('Error loading source points:', error);
                    loading.classList.remove('active');
                    // Don't alert here since source data might not exist yet
                });
        }

        // Update statistics
        function updateStatistics(geojsonData) {
            const total = geojsonData.features.length;
            const acquired = geojsonData.features.filter(f => f.properties.is_acquired).length;
            const pending = total - acquired;
            const pct = total > 0 ? ((acquired / total) * 100).toFixed(1) : 0;

            document.getElementById('total-sources').textContent = total.toLocaleString();
            document.getElementById('acquired-sources').textContent = acquired.toLocaleString();
            document.getElementById('acquired-pct').textContent = pct + '%';
            document.getElementById('pending-sources').textContent = pending.toLocaleString();
        }

        // ===== SIDE PANEL TAB SWITCHING =====

        const tabButtons = document.querySelectorAll('.panel-tab-btn');
        const panelContents = document.querySelectorAll('.panel-content');
        const panelTitle = document.getElementById('panel-title');

        const tabTitles = {
            'actions': 'Actions',
            'filter': 'Filter & Display',
            'selection': 'Selected Shots'
        };

        tabButtons.forEach(button => {
            button.addEventListener('click', function() {
                const targetTab = this.getAttribute('data-tab');

                // Update active tab button
                tabButtons.forEach(btn => btn.classList.remove('active'));
                this.classList.add('active');

                // Update active content
                panelContents.forEach(content => content.classList.remove('active'));
                document.getElementById(targetTab + '-content').classList.add('active');

                // Update panel title
                panelTitle.textContent = tabTitles[targetTab];
            });
        });

        // Panel collapse/expand toggle
        const panelToggle = document.getElementById('panel-toggle');
        const sidePanel = document.getElementById('side-panel');

        panelToggle.addEventListener('click', function() {
            sidePanel.classList.toggle('collapsed');
            this.innerHTML = sidePanel.classList.contains('collapsed') ? '&#9776;' : '&#10005;';
        });

        // Apply filter button handler
        document.getElementById('apply-swath-filter').addEventListener('click', function() {
            const checkboxes = document.querySelectorAll('.filter-checkbox input[type="checkbox"]:checked');
            const selectedSwaths = Array.from(checkboxes).map(cb => parseInt(cb.value));

            if (selectedSwaths.length === 0) {
                alert('Please select at least one swath');
                return;
            }

            loadMapData(selectedSwaths);
        });

        // Toggle all button handler
        document.getElementById('toggle-all-swaths').addEventListener('click', function() {
            const checkboxes = document.querySelectorAll('.filter-checkbox input[type="checkbox"]');
            const allChecked = Array.from(checkboxes).every(cb => cb.checked);

            checkboxes.forEach(cb => cb.checked = !allChecked);
            this.textContent = allChecked ? 'Select All' : 'Deselect All';
        });

        // Base map switching handler
        document.querySelectorAll('input[name="basemap"]').forEach(radio => {
            radio.addEventListener('change', function() {
                const selectedLayer = baseLayers[this.value];
                if (selectedLayer && selectedLayer !== currentBaseLayer) {
                    map.removeLayer(currentBaseLayer);
                    map.addLayer(selectedLayer);
                    currentBaseLayer = selectedLayer;
                }
            });
        });

        // ===== POLYGON SELECTION FEATURE =====

        // Track the current selection polygon
        let currentSelectionPolygon = null;

        // Initialize Leaflet.PM drawing controls
        map.pm.addControls({
            position: 'topright',
            drawPolygon: true,
            drawMarker: false,
            drawCircle: false,
            drawCircleMarker: false,
            drawPolyline: false,
            drawRectangle: false,
            editMode: false,
            dragMode: false,
            cutPolygon: false,
            removalMode: true
        });

        // Handle polygon creation
        map.on('pm:create', function(e) {
            // Remove previous selection if exists
            if (currentSelectionPolygon) {
                map.removeLayer(currentSelectionPolygon);
            }

            currentSelectionPolygon = e.layer;
            const polygonCoords = e.layer.toGeoJSON().geometry.coordinates[0];

            console.log('Polygon created with', polygonCoords.length, 'points');

            // Find unacquired shots within polygon
            const unacquiredShots = findUnacquiredInPolygon(polygonCoords);

            console.log('Found', unacquiredShots.length, 'unacquired shots in polygon');

            // Display results in side panel
            displayInSidePanel(unacquiredShots);
        });

        // Handle polygon removal
        map.on('pm:remove', function(e) {
            if (e.layer === currentSelectionPolygon) {
                currentSelectionPolygon = null;
                // Reset selection tab to empty state
                document.getElementById('selection-content').innerHTML = `
                    <div class="selection-empty">
                        <div class="selection-empty-icon">&#127919;</div>
                        <div class="selection-empty-text">No Selection Yet</div>
                        <div class="selection-empty-hint">Draw a polygon on the map to select unacquired shots</div>
                    </div>
                `;
            }
        });

        // Find unacquired shots within polygon
        function findUnacquiredInPolygon(polygonCoords) {
            const unacquiredShots = [];

            // Iterate through all source points
            sourcePointsLayer.eachLayer(function(layer) {
                const feature = layer.feature;
                const props = feature.properties;

                // Only consider unacquired shots
                if (!props.is_acquired) {
                    const point = {
                        lat: feature.geometry.coordinates[1],
                        lng: feature.geometry.coordinates[0]
                    };

                    // Check if point is inside polygon
                    if (isPointInPolygon(point, polygonCoords)) {
                        unacquiredShots.push({
                            line: props.line,
                            shotpoint: props.shotpoint,
                            swath: props.swath,
                            lat: point.lat,
                            lng: point.lng
                        });
                    }
                }
            });

            return unacquiredShots;
        }

        // Point-in-polygon ray casting algorithm
        function isPointInPolygon(point, polygonCoords) {
            let inside = false;
            const x = point.lng, y = point.lat;

            for (let i = 0, j = polygonCoords.length - 1; i < polygonCoords.length; j = i++) {
                const xi = polygonCoords[i][0], yi = polygonCoords[i][1];
                const xj = polygonCoords[j][0], yj = polygonCoords[j][1];

                const intersect = ((yi > y) !== (yj > y)) &&
                                 (x < (xj - xi) * (y - yi) / (yj - yi) + xi);
                if (intersect) inside = !inside;
            }

            return inside;
        }

        // Display results in selection tab
        function displayInSidePanel(shots) {
            const selectionContent = document.getElementById('selection-content');

            if (shots.length === 0) {
                selectionContent.innerHTML = `
                    <div class="selection-empty">
                        <div class="selection-empty-icon">&#127919;</div>
                        <div class="selection-empty-text">No unacquired shots found</div>
                        <div class="selection-empty-hint">Try drawing a larger polygon or selecting different swaths</div>
                    </div>
                `;
            } else {
                // Group by line and swath
                const grouped = {};
                shots.forEach(shot => {
                    const key = `${shot.line}_${shot.swath}`;
                    if (!grouped[key]) {
                        grouped[key] = {
                            line: shot.line,
                            swath: shot.swath,
                            shotpoints: []
                        };
                    }
                    grouped[key].shotpoints.push(shot.shotpoint);
                });

                // Sort shotpoints and consolidate into ranges
                Object.values(grouped).forEach(group => {
                    group.shotpoints.sort((a, b) => a - b);
                    group.ranges = consolidateToRanges(group.shotpoints);
                });

                // Sort by line number
                const sortedGroups = Object.values(grouped).sort((a, b) => a.line - b.line);

                // Calculate summary stats
                const totalShots = shots.length;
                const uniqueLines = new Set(shots.map(s => s.line)).size;

                // Build HTML
                let html = `
                    <div class="selection-summary">
                        <div class="summary-stat">
                            <strong>Total Unacquired Shots:</strong>
                            <span>${totalShots.toLocaleString()}</span>
                        </div>
                        <div class="summary-stat">
                            <strong>Lines Affected:</strong>
                            <span>${uniqueLines}</span>
                        </div>
                    </div>
                    <div class="selection-list">
                `;

                sortedGroups.forEach(group => {
                    html += `
                        <div class="selection-item" data-swath="${group.swath}">
                            <div class="selection-item-header">
                                <div class="selection-line-number">Line ${group.line}</div>
                                <div class="selection-swath-badge">Swath ${group.swath}</div>
                            </div>
                            <div class="selection-ranges">${group.ranges}</div>
                        </div>
                    `;
                });

                html += `</div>`;
                selectionContent.innerHTML = html;
            }

            // Switch to selection tab and expand panel
            document.querySelector('[data-tab="selection"]').click();
            sidePanel.classList.remove('collapsed');
        }

        // Consolidate consecutive shotpoints into ranges
        function consolidateToRanges(shotpoints) {
            if (shotpoints.length === 0) return '';

            const ranges = [];
            let start = shotpoints[0];
            let end = shotpoints[0];

            for (let i = 1; i < shotpoints.length; i++) {
                if (shotpoints[i] === end + 1) {
                    end = shotpoints[i];
                } else {
                    ranges.push(start === end ? `${start}` : `${start}-${end}`);
                    start = end = shotpoints[i];
                }
            }

            // Add the last range
            ranges.push(start === end ? `${start}` : `${start}-${end}`);

            return ranges.join(', ');
        }

        // ===== UPLOAD TAB FUNCTIONS =====

        // Toggle section collapse/expand
        function toggleSection(sectionId) {
            const section = document.getElementById(sectionId);
            section.classList.toggle('collapsed');
        }

        // Show status message
        function showPanelStatus(elementId, message, type) {
            const el = document.getElementById(elementId);
            el.textContent = message;
            el.className = `upload-status ${type}`;
            el.style.display = 'block';

            // Auto-hide after 10 seconds (except errors)
            if (type !== 'error') {
                setTimeout(() => {
                    el.style.display = 'none';
                }, 10000);
            }
        }

        // Upload S01 file from panel
        async function uploadS01FromPanel() {
            const fileInput = document.getElementById('panel-s01-file');
            const transformSelect = document.getElementById('panel-transformation-select');
            const btn = document.getElementById('panel-s01-upload-btn');

            // Validation
            if (!fileInput.files[0]) {
                showPanelStatus('panel-s01-status', 'Please select a file', 'error');
                return;
            }

            if (!transformSelect.value) {
                showPanelStatus('panel-s01-status', 'Please select a transformation', 'error');
                return;
            }

            // Prepare form data
            const formData = new FormData();
            formData.append('s01_file', fileInput.files[0]);
            formData.append('transformation', transformSelect.value);

            // Disable button and show loading
            btn.disabled = true;
            document.getElementById('s01-btn-text').style.display = 'none';
            document.getElementById('s01-loading').style.display = 'inline';

            try {
                const response = await fetch('/postplot/upload_s01', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                // Re-enable button
                btn.disabled = false;
                document.getElementById('s01-btn-text').style.display = 'inline';
                document.getElementById('s01-loading').style.display = 'none';

                if (data.success) {
                    const msg = `✓ ${data.points || 'Source'} points uploaded\nAccuracy: ${data.rmse_meters.toFixed(2)}m`;
                    showPanelStatus('panel-s01-status', msg, 'success');

                    // Refresh map data
                    setTimeout(() => {
                        loadMapData();
                        refreshStats();
                    }, 1000);
                } else {
                    showPanelStatus('panel-s01-status', data.error || 'Upload failed', 'error');
                }
            } catch (error) {
                btn.disabled = false;
                document.getElementById('s01-btn-text').style.display = 'inline';
                document.getElementById('s01-loading').style.display = 'none';
                showPanelStatus('panel-s01-status', `Error: ${error.message}`, 'error');
            }
        }

        // Upload acquisition files from panel
        async function uploadAcquisitionFromPanel() {
            const fileInput = document.getElementById('panel-acquisition-file');
            const swathSelect = document.getElementById('panel-acquisition-swath');
            const files = fileInput.files;
            const swath = swathSelect.value;

            // Validation
            if (!swath) {
                showPanelStatus('panel-acquisition-status', 'Please select a swath', 'error');
                return;
            }

            if (files.length === 0) {
                showPanelStatus('panel-acquisition-status', 'Please select at least one file', 'error');
                return;
            }

            // Show progress bar
            const progressBar = document.getElementById('acq-progress-bar');
            const progressFill = document.getElementById('acq-progress-fill');
            progressBar.style.display = 'block';

            // Disable button
            const btn = document.getElementById('panel-acquisition-upload-btn');
            btn.disabled = true;
            document.getElementById('acq-btn-text').style.display = 'none';
            document.getElementById('acq-loading').style.display = 'inline';

            let totalUpdated = 0;
            let successCount = 0;
            let failureCount = 0;

            // Sequential upload
            for (let i = 0; i < files.length; i++) {
                const file = files[i];

                // Update progress
                progressFill.style.width = `${((i) / files.length) * 100}%`;
                showPanelStatus('panel-acquisition-status',
                               `Processing ${i + 1}/${files.length}: ${file.name}...`, 'info');

                // Upload file
                const formData = new FormData();
                formData.append('file', file);
                formData.append('swath', swath);

                try {
                    const response = await fetch('/postplot/upload_acquisition', {
                        method: 'POST',
                        body: formData
                    });

                    const data = await response.json();

                    if (data.success) {
                        successCount++;
                        totalUpdated += data.updated || 0;
                    } else {
                        failureCount++;
                    }
                } catch (error) {
                    failureCount++;
                }
            }

            // Complete progress
            progressFill.style.width = '100%';

            // Re-enable button
            btn.disabled = false;
            document.getElementById('acq-btn-text').style.display = 'inline';
            document.getElementById('acq-loading').style.display = 'none';

            // Show final result
            const summary = `✓ ${successCount} succeeded, ${failureCount} failed\n${totalUpdated} shots marked as acquired`;
            showPanelStatus('panel-acquisition-status', summary, successCount > 0 ? 'success' : 'error');

            // Refresh map and stats
            if (successCount > 0) {
                setTimeout(() => {
                    loadMapData();
                    refreshStats();
                    // Hide progress bar after delay
                    setTimeout(() => {
                        progressBar.style.display = 'none';
                        progressFill.style.width = '0%';
                    }, 2000);
                }, 1000);
            }
        }

        // Refresh stats
        async function refreshStats() {
            try {
                const response = await fetch('/postplot/geojson/source_points?swaths=1,2,3,4,5,6,7,8');
                const data = await response.json();

                // Calculate stats by swath
                const statsBySwath = {};
                data.features.forEach(feature => {
                    const swath = feature.properties.swath;
                    if (!statsBySwath[swath]) {
                        statsBySwath[swath] = { total: 0, acquired: 0 };
                    }
                    statsBySwath[swath].total++;
                    if (feature.properties.is_acquired) {
                        statsBySwath[swath].acquired++;
                    }
                });

                // Populate cards
                const grid = document.getElementById('quick-stats-grid');
                grid.innerHTML = '';

                for (let i = 1; i <= 8; i++) {
                    const stats = statsBySwath[i] || { total: 0, acquired: 0 };
                    const percentage = stats.total > 0 ? ((stats.acquired / stats.total) * 100).toFixed(0) : 0;

                    const card = document.createElement('div');
                    card.className = 'stat-card';
                    card.innerHTML = `
                        <div class="stat-card-value">${percentage}%</div>
                        <div class="stat-card-label">Swath ${i}</div>
                        <div class="stat-card-detail">${stats.acquired}/${stats.total}</div>
                    `;
                    grid.appendChild(card);
                }
            } catch (error) {
                console.error('Error refreshing stats:', error);
            }
        }

        // Switch to upload tab
        function switchToUploadTab() {
            document.querySelector('[data-tab="upload"]').click();
        }

        // Initialize upload tab
        function initUploadTab() {
            // Load transformations for panel
            fetch('/postplot/transformations')
                .then(response => response.json())
                .then(data => {
                    const select = document.getElementById('panel-transformation-select');
                    select.innerHTML = '<option value="">-- Select Transformation --</option>';

                    if (data.transformations && data.transformations.length > 0) {
                        data.transformations.forEach(transform => {
                            const option = document.createElement('option');
                            option.value = transform.name;
                            option.textContent = `${transform.name} (${transform.rmse_meters.toFixed(2)}m accuracy)`;
                            select.appendChild(option);
                        });
                    }
                })
                .catch(error => console.error('Error loading transformations:', error));

            // File input change handler
            document.getElementById('panel-acquisition-file')?.addEventListener('change', function(e) {
                const files = e.target.files;
                const fileListDiv = document.getElementById('panel-file-list');

                if (files.length === 0) {
                    fileListDiv.innerHTML = '';
                } else if (files.length === 1) {
                    fileListDiv.innerHTML = `📄 ${files[0].name}`;
                } else {
                    fileListDiv.innerHTML = `📄 ${files.length} files selected`;
                }
            });

            // Load initial stats
            refreshStats();

            // Update tab titles
            const tabTitles = {
                'actions': 'Actions',
                'filter': 'Filter & Display',
                'selection': 'Selected Shots',
                'upload': 'Upload Data'
            };

            // Update panel title when switching tabs
            const originalTabSwitching = document.querySelectorAll('.panel-tab-btn');
            originalTabSwitching.forEach(btn => {
                if (!btn.hasAttribute('data-initialized')) {
                    btn.setAttribute('data-initialized', 'true');
                    const originalClick = btn.onclick;
                    btn.onclick = function() {
                        if (originalClick) originalClick.call(this);
                        const tab = this.getAttribute('data-tab');
                        document.getElementById('panel-title').textContent = tabTitles[tab] || 'Actions';
                    };
                }
            });
        }

        // ===== END UPLOAD TAB FUNCTIONS =====

        // Initial load (all swaths)
        loadMapData();

        // Initialize upload tab
        initUploadTab();
    </script>
</body>
</html>
