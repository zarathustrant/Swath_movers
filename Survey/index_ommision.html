<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Zone Editor</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/handsontable@14.0.0/dist/handsontable.full.min.css">
  <style>
    html, body {
      margin: 0;
      padding: 20px;
      font-family: Arial, sans-serif;
    }
    #filters {
      margin-bottom: 10px;
    }
    #receiver-filter {
      padding: 6px 12px;
      font-size: 16px;
      width: 300px;
    }
    #hot {
      margin-top: 10px;
    }
    button {
      margin-top: 12px;
      padding: 10px 18px;
      font-size: 16px;
    }
  </style>
</head>
<body>

<h2>Zone Editor Table</h2>

<div id="filters">
  <input id="receiver-filter" list="receiver-list" placeholder="üîç Filter by Receiver..." oninput="applyFilters()">
  <datalist id="receiver-list"></datalist>
</div>

<div id="hot"></div>
<button onclick="saveData()">üíæ Save to Database</button>

<script src="https://cdn.jsdelivr.net/npm/handsontable@14.0.0/dist/handsontable.full.min.js"></script>
<script>
  let hot;
  let fullData = [];

  const zoneOptions = [
    'Forest', 'Creek', 'Farmland', 'Urban', 'Industrial', 'Swamp', 'Mangrove',
    'Savanna', 'Wetland', 'Bushland', 'Grassland', 'Scrubland', 'Hilltop',
    'Lowland', 'Valley', 'Residential', 'Commercial', 'School Zone', 'Playground',
    'Rocky', 'Dry Area', 'Wet Area', 'Dump Site', 'Gas Zone', 'Oil Zone',
    'Protected Area', 'Research Area', 'Old Pipeline', 'New Pipeline'
  ];

  const zoneToColor = (zone) => {
    const map = {
      'forest': 'green', 'creek': 'blue', 'farmland': 'orange', 'urban': 'red', 'industrial': 'gray',
      'swamp': 'purple', 'mangrove': 'darkgreen', 'savanna': 'yellow', 'wetland': 'teal',
      'bushland': 'olive', 'grassland': 'lightgreen', 'scrubland': 'darkolivegreen', 'hilltop': 'brown',
      'lowland': 'lightblue', 'valley': 'lightgray', 'residential': 'pink', 'commercial': 'gold',
      'school zone': 'violet', 'playground': 'skyblue', 'rocky': 'saddlebrown', 'dry area': 'tan',
      'wet area': 'aquamarine', 'dump site': 'black', 'gas zone': 'navy', 'oil zone': 'maroon',
      'protected area': 'lime', 'research area': 'indigo', 'old pipeline': 'slategray', 'new pipeline': 'darkred'
    };
    return map[zone?.toLowerCase().trim()] || 'gray';
  };

  fetch('/data')
    .then(r => r.json())
    .then(data => {
      fullData = data;

      const receivers = [...new Set(data.map(d => d.Receiver))];
      const receiverList = document.getElementById('receiver-list');
      receiverList.innerHTML = '';
      receivers.forEach(name => {
        const opt = document.createElement('option');
        opt.value = name;
        receiverList.appendChild(opt);
      });

      renderTable(data);
    });

  function renderTable(data) {
    const container = document.getElementById('hot');
    if (hot) hot.destroy();

    hot = new Handsontable(container, {
      data: data,
      colHeaders: [
        'Receiver', 'Shotpoint', 'Zone', 'Color', 'Type', 'SurveyorName', 'WorkDate'
      ],
      columns: [
        { data: 'Receiver', type: 'text' },
        { data: 'Shotpoint', type: 'text' },
        {
          data: 'Zone',
          type: 'autocomplete',
          source: zoneOptions,
          strict: false,
          allowInvalid: true,
          filter: true,
          visibleRows: 10
        },
        { data: 'Color', readOnly: true },
        { data: 'Type', type: 'text' },
        { data: 'SurveyorName', type: 'text' },
        { data: 'WorkDate', type: 'date', dateFormat: 'YYYY-MM-DD' }
      ],
      rowHeaders: true,
      filters: true,
      dropdownMenu: true,
      stretchH: 'all',
      contextMenu: true,
      manualColumnResize: true,
      licenseKey: 'non-commercial-and-evaluation',
      fillHandle: {
        direction: 'vertical',
        autoInsertRow: false
      },
      afterChange(changes) {
        if (!changes) return;
        changes.forEach(([row, prop, oldVal, newVal]) => {
          if (prop === 'Zone') {
            const newColor = zoneToColor(newVal);
            hot.setDataAtCell(row, 3, newColor);
          }
        });
      },

      cells: function (row, col) {
        const cellProperties = {};
        const colName = this.instance.getColHeader(col);
        if (colName === 'Color') {
          const color = this.instance.getDataAtCell(row, col);
          cellProperties.renderer = function (instance, td, row, col, prop, value, cellProps) {
            Handsontable.renderers.TextRenderer.apply(this, arguments);
            td.style.backgroundColor = value;
            td.style.color = (value === 'black' || value === 'navy' || value === 'maroon') ? 'white' : 'black';
          };
        }
        return cellProperties;
      }
    });
  }

  function applyFilters() {
    const receiverQuery = document.getElementById('receiver-filter').value.toLowerCase();
    const filtered = fullData.filter(row =>
      !receiverQuery || (row.Receiver || '').toLowerCase().includes(receiverQuery)
    );
    renderTable(filtered);
  }

  function saveData() {
    const data = hot.getData();
    const headers = hot.getColHeader();

    const payload = data.map(row => {
      let obj = {};
      headers.forEach((col, i) => {
        obj[col] = row[i];
      });

      const match = fullData.find(f => f.Receiver === obj.Receiver && f.Shotpoint === obj.Shotpoint);
      obj.Latitude = match?.Latitude || '';
      obj.Longitude = match?.Longitude || '';
      obj._id = match?._id || `${obj.Receiver}_${obj.Shotpoint}`;
      return obj;
    });

    fetch('/save', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    })
    .then(r => {
      if (r.ok) {
        alert("‚úÖ Saved successfully");
      } else {
        alert("‚ùå Failed to save");
      }
    });
  }
</script>

</body>
</html>